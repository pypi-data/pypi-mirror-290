Metadata-Version: 2.1
Name: bepatient-db
Version: 0.4.0
Summary: Plugin for the 'bepatient' library adding database support.
Author-email: Dawid Szaniawski <webluduspl@gmail.com>
License: MIT License
        
        Copyright (c) 2023 Dawid Szaniawski
        
        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:
        
        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.
        
        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
        
Project-URL: Source, https://github.com/dawid-szaniawski/bepatient-db
Keywords: api,async,api_testing,automation,database,json,mySQL,postgreSQL,SQL,SQLite,testing,web
Classifier: Development Status :: 3 - Alpha
Classifier: Environment :: Web Environment
Classifier: Intended Audience :: Developers
Classifier: Natural Language :: English
Classifier: Operating System :: OS Independent
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Python :: 3 :: Only
Classifier: Programming Language :: Python :: Implementation :: CPython
Classifier: Topic :: Internet :: WWW/HTTP
Classifier: Topic :: Software Development :: Libraries
Classifier: Topic :: Software Development :: Testing
Classifier: Topic :: Software Development :: Quality Assurance
Classifier: Topic :: Utilities
Classifier: Topic :: File Formats :: JSON
Classifier: Topic :: File Formats :: JSON :: JSON Schema
Classifier: Typing :: Typed
Classifier: Topic :: Database
Classifier: Topic :: Database :: Database Engines/Servers
Classifier: Programming Language :: SQL
Requires-Python: >=3.10
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: bepatient>=0.10.2
Requires-Dist: dictor>=0.1.12
Requires-Dist: mysql-connector-python~=8.1.0
Requires-Dist: psycopg2-binary~=2.9.7
Provides-Extra: dev
Requires-Dist: black>=24.8.0; extra == "dev"
Requires-Dist: flake8>=7.1.1; extra == "dev"
Requires-Dist: isort>=5.13.2; extra == "dev"
Requires-Dist: mypy>=1.11.1; extra == "dev"
Requires-Dist: pylint>=3.2.6; extra == "dev"
Requires-Dist: pytest>=8.3.2; extra == "dev"
Requires-Dist: pytest-cov>=5.0.0; extra == "dev"
Requires-Dist: pytest-mock>=3.14.0; extra == "dev"
Requires-Dist: ruff>=0.5.7; extra == "dev"
Requires-Dist: tox>=4.17.1; extra == "dev"
Requires-Dist: twine>=5.1.1; extra == "dev"
Provides-Extra: docs
Requires-Dist: mkdocs-material>=9.5.31; extra == "docs"
Requires-Dist: mkdocs-minify-plugin>=0.8.0; extra == "docs"

[![Tests](https://github.com/dawid-szaniawski/bepatient-db/actions/workflows/tox.yml/badge.svg)](https://github.com/dawid-szaniawski/bepatient-db/actions/workflows/tox.yml)
[![PyPI - Python Version](https://img.shields.io/pypi/pyversions/bepatient-db)](https://pypi.org/project/bepatient-db/)
[![PyPI](https://img.shields.io/pypi/v/bepatient-db)](https://pypi.org/project/bepatient-db/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://github.com/dawid-szaniawski/bepatient-db/blob/master/LICENSE)
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)
[![Ruff](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/astral-sh/ruff/main/assets/badge/v2.json)](https://github.com/astral-sh/ruff)
[![codecov](https://codecov.io/github/dawid-szaniawski/bepatient-db/branch/master/graph/badge.svg?token=hY7Nb5jGgi)](https://codecov.io/github/dawid-szaniawski/bepatient-db)
[![CodeFactor](https://www.codefactor.io/repository/github/dawid-szaniawski/bepatient-db/badge)](https://www.codefactor.io/repository/github/dawid-szaniawski/bepatient-db)

# bepatient-db

Plugin for the `bepatient` library adding database support.
It enables the repeated execution of database queries while waiting for a specific
condition to be met.

## Supported databases:

- PostgreSQL,
- MySQL,
- SQLite.

## Installation

To install _bepatient-db_, you can use pip:

```bash
pip install bepatient-db
```

_bepatient_ supports Python 3.10+

## Usage

First and foremost, we need to configure the database connection. `SQLWaiter` utilizes
the `Cursor` object of supported databases. Data returned by the `Cursor` should be in
the format of a list of dictionaries (`list[dict]`) or a dictionary (`dict`).
Each of the supported databases allows for such configuration.

### SQLite example

```python
import sqlite3

from flask import current_app, g


def dict_factory(cur, row):
    fields = [column[0] for column in cur.description]
    return dict(zip(fields, row))


def get_db():
    if 'db' not in g:
        g.db = sqlite3.connect(
            current_app.config['DATABASE'],
            detect_types=sqlite3.PARSE_DECLTYPES
        )
        g.db.row_factory = dict_factory

    return g.db


def close_db(e=None):
    db = g.pop('db', None)

    if db is not None:
        db.close()
```

With the `Cursor` configured in this way, we can use `SQLWaiter` to repeatedly execute
queries until we receive the desired data or reach a predefined number of attempts.



Database: `user`

| id | name  |
|----|-------|
| 1  | Bob   |
| 2  | Jerry |
| 3  | Matt  |


```python
from sqlite3 import Cursor

from bepatient_db import SQLWaiter


def wait_for_user(cursor: Cursor) -> list[dict[str, str]]:
    waiter = SQLWaiter(cursor=cursor, query="SELECT name FROM user")
    waiter.add_checker(
        expected_value="Bob", comparer="is_equal", dict_path="0.name"
    )
    return waiter.run(retries=1).get_result()
```

Output:

```python
[
    {"name": "Bob"},
    {"name": "Jerry"},
    {"name": "Matt"},
]
```

## License

MIT License

Copyright (c) 2023 Dawid Szaniawski

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
