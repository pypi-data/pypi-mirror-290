[tox]
min_version = 4
env_list =
    pre-commit,
    mypy,
    pyright,
    py3{8,9,10,11,12}-tests,
    py3{8,12}-tests-coverage,
    coverage-report,
    docs

[testenv]
package = wheel
wheel_build_env = .pkg
extras =
    tests: tests
commands =
    tests: pytest {posargs}

[testenv:py3{8,12}-tests-coverage]
set_env =
    py312: COVERAGE_CORE=sysmon
deps =
    coverage[toml]
commands = coverage run -m pytest {posargs}

[testenv:coverage-report]
# Keep in-sync with .python-version
base_python = py312
deps = coverage[toml]
skip_install = true
parallel_show_output = true
# Keep in-sync with test env definition above.
depends = py3{8,12}-tests
commands =
    coverage combine
    coverage report

[testenv:mypy]
extras = typing
commands = mypy src

[testenv:pyright]
deps = pyright
extras = typing
commands = pyright src

[testenv:docs]
extras = docs
allowlist_externals =
    git
    rm
commands =
    rm -rf docs/_build
    rm -rf docs/apidocs
    sphinx-build -W -n --jobs auto -b html -d docs/_build/doctrees docs docs/_build/html
    git cliff --output CHANGELOG.md

[testenv:pre-commit]
skip_install = true
deps = pre-commit
commands = pre-commit run --all-files
